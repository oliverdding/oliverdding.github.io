<!doctype html><html lang=zh><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ffffff name=theme-color><meta content=#da532c name=msapplication-TileColor><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css integrity=sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css integrity=sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6 rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity=sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css integrity=sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q rel=stylesheet><link href=https://charmer.fun/deep-thought.css rel=stylesheet><title> Aurora | Count-Min Sketch </title><script src="https://www.googletagmanager.com/gtag/js?id=G-LXDSXGWDES" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-LXDSXGWDES");</script><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js></script><body class=has-background-white><nav aria-label="section navigation" class="navbar is-light" role=navigation><div class=container><div class=navbar-brand><a class="navbar-item is-size-5 has-text-weight-bold" href=https://charmer.fun>Aurora</a><a class="navbar-burger burger" aria-expanded=false aria-label=menu data-target=navMenu role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navMenu><div class="navbar-end has-text-centered"><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/> Home </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/posts> Posts </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/categories> Categories </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/tags> Tags </a><a class=navbar-item data-target=#search-modal id=nav-search title=Search> <span class=icon> <i class="fas fa-search"></i> </span> </a><a title="Switch to dark theme" class=navbar-item id=dark-mode> <span class=icon> <i class="fas fa-adjust"></i> </span> </a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-8 is-offset-2"><article class=box><h1 class=title>Count-Min Sketch</h1><p class=subtitle>不精确但低消耗地统计海量数据流中每个元素的个数<div class="columns is-multiline is-gapless"><div class="column is-8"><span class="icon-text has-text-grey"> <span class=icon> <i class="fas fa-user"></i> </span> <span>charmer published on</span> <span class=icon> <i class="far fa-calendar-alt"></i> </span> <span><time datetime=2022-03-15T22:58:53+08:00>March 15, 2022</time></span> </span></div><div class="column is-4 has-text-right-desktop"><span class="icon-text has-text-grey"> <span class=icon> <i class="far fa-clock"></i> </span> <span>7 min,</span> <span class=icon> <i class="fas fa-pencil-alt"></i> </span> <span>1222 words</span> </span></div><div class=column><p>Categories: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/categories/probabilisticdatastructure/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>ProbabilisticDataStructure</span> </span> </a></div><div class="column has-text-right-desktop"><p>Tags: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/tags/data-structure/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>data structure</span> </span> </a></div></div><div class="content mt-2"><p>本文将介绍<a href=/categories/probabilisticdatastructure/>概率性数据结构</a>这个专题的第三个数据结构，实际上它只是<a href=/posts/bloom-filter-1/>布隆过滤器</a>的一个变体，它的结构几乎和计数布隆过滤器一致，但是解决不同的问题。<p>在上篇文章<a href=/posts/hyper-log-log/>HyperLogLog</a>中我们提到基数统计问题，换个问题，如果要统计海量的数据流中每个元素的出现次数呢？<p>一看这个问题我们自然又会想到hash数据结构，但相比于<a href=/posts/hyper-log-log/#hashset-bitmap>HyperLogLog</a>一文中使用的HashSet，我们需要使用HashMap用value作为counter计数。<p>理所当然，原型方案只是用于提供一个解决问题的思路与方式，我们需要考虑它的局限。假设流中有千万个数据，若它们都不一样，那HashMap中就有千万个键值对，空间占用可想而知。本文介绍的Count-Min Sketch(CMS)就是利用概率的方式解决空间消耗过大问题。<p>⚠️ 相比于论文<sup class=footnote-reference><a href=#1>1</a></sup>，本文的查询只涉及point query，而不涉及range query和inner product query。<p>可以先看这个视频对本文有直观的认识<div class="youtube is-flex is-justify-content-center is-align-items-center"><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen frameborder=0 height=510 src=https://www.youtube.com/embed/mPxslXpg8wA width=848></iframe></div><h2 id=li-yong-hashjie-sheng-kong-jian>利用Hash节省空间</h2><p>首先想到的方案是利用Hash函数和数组，将元素Hash结果作为index，在数组中统计，这样就可以节省掉HashMap中存储key的空间。<p>首先准备一个Hash函数$h$，一个长度为$w$的数组$count$。<ul><li><p>初始化时将$count$数组元素初始化为0：$count[i] = 0, 0\le{}i\lt{}w$</p><li><p>添加元素时，对元素$a$计算Hash值并对$w$取模，作为下标将$count$数组中对应元素自增：$count[h(a)\mod{}w]+=1$。</p> <p><img alt=插入元素示例 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/single-array-in-count-min-sketch.drawio.svg></p><li><p>查询元素时，同样方式获取下标然后返回数组元素内容：$count[h(a)\mod{}w]$。</p></ul><p>这种方式有一个致命缺陷：Hash碰撞。一旦发生Hash碰撞，意味着碰撞的两个元素的统计值（两个元素的个数总和）会大于实际值，也就是说返回的值一定是上限，大于等于真实值。想缓解这个问题，看起来我们只能分配一个足够大的数组，并且运用一些Hash碰撞的解决办法。那么有没有更简单的办法呢？<h2 id=cms>CMS</h2><p>既然一个Hash函数+数组容易发生碰撞，那么如果引入多个Hash函数与多个数组呢？这就是CMS的解决办法。<p>首先准备$d$个Hash函数$h_1,h_2,...,h_d$，一个宽度为$w$深度为$d$的二维数组$count$。<p><img alt=空count数组 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/empty-cms.drawio.svg><ul><li><p>初始化时将$count$数组元素初始化为0：$count[i, j] = 0, 0\le{}i\lt{}w, 0\le{}j\lt{}d$</p><li><p>添加元素时，对元素$a$计算$d$个Hash值，并将二维数组中Hash函数对应的一维数组的元素自增：$count[i, h_i(a)\mod{}w]+=1$（$0\le{}i\lt{}d$的全部元素）</p> <p><img alt=插入元素示例 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/cms-insert.drawio.svg></p><li><p>查询元素时，同样获得$d$个Hash值，并取得对应的$d$个元素中的最小值：$min_{i=0}^{d-1}count[i, h_i(a)\mod{}w]$（$0\le{}i\lt{}d$的全部元素）</p> <p><img alt=查询元素示例 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/cms-query.drawio.svg></p></ul><p>通过多个Hash函数与多个数组（一维数组）的方式，尽可能避免Hash碰撞的影响，这就是CMS的全部内容，一般将底层的二维数组称为sketch。<p>可是如何能证明它的的概率可用？$d$、$w$应该取什么值呢？<h2 id=li-lun-bu-fen>理论部分</h2><p>论文引入了两个符号$\varepsilon$和$\delta$，这两个都是用户根据自己可用资源和所需目标给定的值，除此之外令$\parallel{}count\parallel{}_1$为sketch所有元素的总和。<p><strong>理论</strong>： 用户设定$\varepsilon$和$\delta$后，可以根据公式$$w=\lceil{}\frac{e}{\varepsilon}\rceil{}$$和$$d=\lceil{}ln\frac{1}{\delta}\rceil{}$$计算$w$和$d$的值。论文<sup class=footnote-reference><a href=#1>1</a></sup>证明，可以在$1-\delta$的概率内，误差最大为$\varepsilon{}\ast{}\parallel{}count\parallel{}_1$<p>主观上体会，增加新的Hash函数可以降低超出最大误差的概率，因为新增后还是超出最大误差需要新增的Hash函数也发生Hash碰撞，而不同Hash函数间相互独立，具有指数效应。<p>增加宽度有助于分散计数，降低最大误差，但是这只是线性的。<p>一般而言，sketch的宽度（$w$）会远远大于深度（$d$），过多的Hash函数（$d$）会造成额外的开销。同时，随着Hash函数（$d$）增多，$\delta$会极速缩小。<h2 id=can-kao>参考</h2><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>Graham Cormode and S. Muthukrishnan. 2005. An improved data stream summary: the count-min sketch and its applications. Journal of Algorithms 55, 1 (2005), 58–75</div></div></article></div><div class="column is-2 is-hidden-mobile"><aside style="position: sticky; top: 48px" class=menu><p class="heading has-text-weight-bold">Contents<ul class=menu-list><li><a class="toc is-size-7 is-active" href=https://charmer.fun/posts/count-min-sketch/#li-yong-hashjie-sheng-kong-jian id=link-li-yong-hashjie-sheng-kong-jian> 利用Hash节省空间 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/count-min-sketch/#cms id=link-cms> CMS </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/count-min-sketch/#li-lun-bu-fen id=link-li-lun-bu-fen> 理论部分 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/count-min-sketch/#can-kao id=link-can-kao> 参考 </a></ul></aside></div></div></div></section><section class=modal id=search-modal><div class=modal-background></div><div class=modal-card><header class=modal-card-head><p class=modal-card-title>Search</header><section class=modal-card-body><div class="field mb-2"><div class=control><input placeholder="Search this website." class=input id=search type=search></div></div><div class=search-results><div class=search-results__items></div></div></section></div><button class="modal-close is-large" aria-label=close></button></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-8"><nav class=level><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/what-is-spark-job/> <span class="icon mr-2"> <i class="fas fa-arrow-circle-left"></i> </span> 到底什么是Spark Job </a></div><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/rust-traits-and-trait-objects/> trait对象的静态分发与动态分发<span class="icon ml-2"> <i class="fas fa-arrow-circle-right"></i> </span> </a></div></nav></div></div></div></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-6"><div id=disqus_thread></div></div></div></div></section><footer class="footer py-4"><div class="content has-text-centered"><p>Built with <span class=icon-text> <span class=icon> <i class="fas fa-code"></i> </span> <span>code</span> </span> and <span class=icon-text> <span class=icon> <i class="fas fa-heart"></i> </span> <span>love</span> </span><p>Powered by <span class=icon-text> <span class=icon> <i class="fas fa-power-off"></i> </span> <span>zola</span> </span></div></footer><script crossorigin=anonymous integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js></script><script crossorigin=anonymous integrity=sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js></script><script crossorigin=anonymous integrity=sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js></script><script crossorigin=anonymous integrity=sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv src=https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js></script><script crossorigin=anonymous integrity=sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs src=https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js></script><script src=https://charmer.fun/elasticlunr.min.js></script><script src=https://charmer.fun/search_index.zh.js></script><script src=https://charmer.fun/js/site.js></script><script>const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);</script><script>var disqus_config = function () {
    this.page.url = "https://charmer.fun";
    this.page.identifier = "/posts/count-min-sketch/";
  };

  (function () {
    var d = document, s = d.createElement('script');
    s.src = 'https://oliverdding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();</script>