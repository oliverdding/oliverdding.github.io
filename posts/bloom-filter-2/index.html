<!doctype html><html lang=zh><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ffffff name=theme-color><meta content=#da532c name=msapplication-TileColor><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css integrity=sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css integrity=sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6 rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity=sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css integrity=sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q rel=stylesheet><link href=https://charmer.fun/deep-thought.css rel=stylesheet><title> Aurora | 2 可扩展布隆过滤器 </title><script src="https://www.googletagmanager.com/gtag/js?id=G-LXDSXGWDES" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-LXDSXGWDES");</script><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js></script><body class=has-background-white><nav aria-label="section navigation" class="navbar is-light" role=navigation><div class=container><div class=navbar-brand><a class="navbar-item is-size-5 has-text-weight-bold" href=https://charmer.fun>Aurora</a><a class="navbar-burger burger" aria-expanded=false aria-label=menu data-target=navMenu role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navMenu><div class="navbar-end has-text-centered"><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/> Home </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/posts> Posts </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/categories> Categories </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/tags> Tags </a><a class=navbar-item data-target=#search-modal id=nav-search title=Search> <span class=icon> <i class="fas fa-search"></i> </span> </a><a title="Switch to dark theme" class=navbar-item id=dark-mode> <span class=icon> <i class="fas fa-adjust"></i> </span> </a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-8 is-offset-2"><article class=box><h1 class=title>2 可扩展布隆过滤器</h1><p class=subtitle>基于布隆过滤器的一个变种实现的可扩展布隆过滤器，无需使用前预估存储量<div class="columns is-multiline is-gapless"><div class="column is-8"><span class="icon-text has-text-grey"> <span class=icon> <i class="fas fa-user"></i> </span> <span>charmer published on</span> <span class=icon> <i class="far fa-calendar-alt"></i> </span> <span><time datetime=2022-02-15T14:00:16+08:00>February 15, 2022</time></span> </span></div><div class="column is-4 has-text-right-desktop"><span class="icon-text has-text-grey"> <span class=icon> <i class="far fa-clock"></i> </span> <span>7 min,</span> <span class=icon> <i class="fas fa-pencil-alt"></i> </span> <span>1308 words</span> </span></div><div class=column><p>Categories: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/categories/probabilisticdatastructure/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>ProbabilisticDataStructure</span> </span> </a> <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/categories/bloomfilter/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>BloomFilter</span> </span> </a></div><div class="column has-text-right-desktop"><p>Tags: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/tags/data-structure/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>data structure</span> </span> </a></div></div><div class="content mt-2"><h2 id=jie-shao>介绍</h2><p>在上篇博文<a href=/posts/bloom-filter-1/>基础布隆过滤器</a>中介绍了基础的bloom filter以及相关数学推导，最后给出了应用最佳实践。在文章最后提及基础布隆过滤器无法在保证false positive率的同时扩展存储，必须在使用前预估集合大小（n）。但是在很多情况下，集合大小无法预估，这就需要使用本篇介绍的布隆过滤器变体。<h2 id=bu-long-guo-lu-qi-bian-ti>布隆过滤器变体</h2><p>布隆过滤器变体由以下两部分构成：<ol><li>M位的位图：<code>bitmap</code><li>k个相互独立的hash函数：<code>h1, h2, ..., hk</code></ol><p>其中，M位的位图被k等分，每个slice长度为m，即$m=\frac{M}{k}$。<p>与基础布隆过滤器不同的是，每个hash函数独享自己对应的slice（而不是全部位图）。<p>这种变体提高了健壮性，并且支持并发处理。<h3 id=shu-xue-tui-dao>数学推导</h3><p>对于某个slice，插入1个元素后，某一个位被置1、置0的概率为$\frac{1}{m}$、$1-\frac{1}{m}$<p>当插入n个元素后，某一位被置0、置1的概率是$(1-\frac{1}{m})^n$、$1-(1-\frac{1}{m})^n$<p>同样使用自然对数e的计算公式$$\lim_{x \to \infty}{(1-\frac{1}{x})^{-x}}=e$$<p>插入n个元素后某一位被置1的概率可以简化为$$p\approx{}1-e^{-\frac{n}{m}}$$<p>于是得到$$n\approx{}-mln(1-p)$$<p>又由公式$M=km$和$P=p^k$，我们推导出$m=M\frac{ln(p)}{ln(P)}$，因此有$$n\approx{}M\frac{ln(p)ln(1-p)}{-ln(P)}$$<p>对于给定的纳伪率$P$和位图大小M，当$p=\frac{1}{2}$时n取到最大值，此时能容纳最多的元素。$p$代表一个slice的饱和程度，我们得知slice半饱和时最好，对于$p=\frac{1}{2}$我们可以简化上面的公式为$$n\approx{}M\frac{(ln(2)^2)}{\lvert{}ln(P)\rvert{}}$$<p>P是给定的纳伪率，因此对于这个布隆过滤器变体而言，可以容纳的元素数量n是和位图大小M呈线性关系。<p>最后由$P=p^k$和$p=\frac{1}{2}$我们推导出$$k=log_{2}\frac{1}{P}$$<h3 id=ying-yong>应用</h3><h4 id=yi-zhi-n-he-p>已知$n$和$P$</h4><ol><li>根据公式$k=\lceil{}log_{2}\frac{1}{P}\rceil{}$计算k的值<li>根据公式$m\approx{}\lceil{}\frac{n\lvert{}ln(P)\rvert{}}{kln^2(2)}\rceil{}$计算m的值</ol><h2 id=ke-kuo-zhan-de-bu-long-guo-lu-qi>可扩展的布隆过滤器</h2><p>本篇介绍的可扩展布隆过滤器（Scalable Bloom Filter, SBF）基于前文提及的布隆过滤器变体，有两个关键部分：<ul><li>SBF由一个或多个布隆过滤器组成。当现有过滤器“满了”（由于纳伪率达到上限），就会从创建新的过滤器。此时查询需要经过所有的过滤器。<li>后续的布隆过滤器的纳伪率成等比数列缩小，以保证整体纳伪率保持在一个数值内。</ul><h3 id=shu-xue-tui-dao-1>数学推导</h3><p>SBF创建时只有一个布隆过滤器，$k_0$个slice，纳伪率为$P_0$。当这个过滤器满了，添加新的过滤器（$k_1$个slice，纳伪率为$P_1=P_{0}r$，且$0&LTr&LT1$）。<p>当SBF存在$l$个过滤器后，其纳伪率为$$P=1-\prod_{i=0}^{l-1}(1-P_{0}r^i)$$<p>由于有缩放公式$$1-\prod_{i}(1-P_i)\le{}\sum_{i}P_i$$<p>我们可以得到P的上限$$P\le{}\sum_{i=0}^{l-1}P_{0}r^{i}\le{}\lim_{l \to \infty}\sum_{i=0}^{l-1}P_{0}r^i$$<p>因此有$$P\le{}P_{0}\frac{1}{1-r}$$<p>每个过滤器的slice长度为$$k_{0}=log_{2}(P_{0}^{-1})$$，$$k_{i}=log_{2}(P_{i}^{-1})=k_{0}+ilog_{2}(r^{-1}) \tag{1}$$<p>为了保证每个k_i都是整数，我们自然会想让$r=\frac{1}{2}$，此时有$$k_i=k_0+i$$，意味着每添加一个过滤器都需要扩充一个slice。此时SBF的整体纳伪率为$$P\le{}2P_0=2^{1-k_0}$$<p>论文证明了如果$r\lt{}0.5$，尽管小量数据时使用空间大于$r=0.5$，随着空间增长空间使用反而更小。论文实验证明，r取0.8～0.9时为最佳。[1]<p>事实上，后续添加的过滤器的纳伪率$P_i$只要低于整体纳伪率，则可保证整体纳伪率不增加。因此$k_i$的选取可以更加灵活，而不局限于(1)的公式。由于$P_i$和$k_i$成反比，只要$k_i$选取大于(1)的值即可保证$P_i$小。这里为了简化我们可以使用等比数列。假设k的取值为$P_0, P_{0}r, P_{0}r^2,...,P_{0}r^{l-1}$，此时过滤器可以存储的变量数$n_i$大约为$$n_i\approx{}m_{0}s^{i}ln(2)$$，有$l$个过滤器的SBF可以存储约$(ln2)m_{0}\sum_{i=0}^{l-1}s^i$个元素。<p>论文证明对于缓慢增长的SBF可以考虑设置$s=2$，对于快速增长的过滤器可以设置$s=4$。<h3 id=ying-yong-1>应用</h3><h4 id=yi-zhi-p>已知$P$</h4><ol><li>考虑使用$n=8192$构造初始布隆过滤器变体，计算获得$k_0$和m<li>对于每个后续的$P_i=0.9P_{i-1}$<li>对于每个后续的过滤器，$k_i=2k_{i-1}$或$k_i=4k_{i-1}$</ol><h2 id=can-kao>参考</h2><ul><li>[1]: Scalable Bloom Filters</ul></div></article></div><div class="column is-2 is-hidden-mobile"><aside style="position: sticky; top: 48px" class=menu><p class="heading has-text-weight-bold">Contents<ul class=menu-list><li><a class="toc is-size-7 is-active" href=https://charmer.fun/posts/bloom-filter-2/#jie-shao id=link-jie-shao> 介绍 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#bu-long-guo-lu-qi-bian-ti id=link-bu-long-guo-lu-qi-bian-ti> 布隆过滤器变体 </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#shu-xue-tui-dao id=link-shu-xue-tui-dao> 数学推导 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#ying-yong id=link-ying-yong> 应用 </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#ke-kuo-zhan-de-bu-long-guo-lu-qi id=link-ke-kuo-zhan-de-bu-long-guo-lu-qi> 可扩展的布隆过滤器 </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#shu-xue-tui-dao-1 id=link-shu-xue-tui-dao-1> 数学推导 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#ying-yong-1 id=link-ying-yong-1> 应用 </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-2/#can-kao id=link-can-kao> 参考 </a></ul></aside></div></div></div></section><section class=modal id=search-modal><div class=modal-background></div><div class=modal-card><header class=modal-card-head><p class=modal-card-title>Search</header><section class=modal-card-body><div class="field mb-2"><div class=control><input placeholder="Search this website." class=input id=search type=search></div></div><div class=search-results><div class=search-results__items></div></div></section></div><button class="modal-close is-large" aria-label=close></button></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-8"><nav class=level><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/hyper-log-log/> <span class="icon mr-2"> <i class="fas fa-arrow-circle-left"></i> </span> HyperLogLog </a></div><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/best-practice-for-writing-blog-with-ssg/> 使用静态网站写博客的最佳实践<span class="icon ml-2"> <i class="fas fa-arrow-circle-right"></i> </span> </a></div></nav></div></div></div></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-6"><div id=disqus_thread></div></div></div></div></section><footer class="footer py-4"><div class="content has-text-centered"><p>Built with <span class=icon-text> <span class=icon> <i class="fas fa-code"></i> </span> <span>code</span> </span> and <span class=icon-text> <span class=icon> <i class="fas fa-heart"></i> </span> <span>love</span> </span><p>Powered by <span class=icon-text> <span class=icon> <i class="fas fa-power-off"></i> </span> <span>zola</span> </span></div></footer><script crossorigin=anonymous integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js></script><script crossorigin=anonymous integrity=sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js></script><script crossorigin=anonymous integrity=sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js></script><script crossorigin=anonymous integrity=sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv src=https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js></script><script crossorigin=anonymous integrity=sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs src=https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js></script><script src=https://charmer.fun/elasticlunr.min.js></script><script src=https://charmer.fun/search_index.zh.js></script><script src=https://charmer.fun/js/site.js></script><script>const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);</script><script>var disqus_config = function () {
    this.page.url = "https://charmer.fun";
    this.page.identifier = "/posts/bloom-filter-2/";
  };

  (function () {
    var d = document, s = d.createElement('script');
    s.src = 'https://oliverdding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();</script>