<!doctype html><html lang=zh><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ffffff name=theme-color><meta content=#da532c name=msapplication-TileColor><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css integrity=sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css integrity=sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6 rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity=sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css integrity=sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q rel=stylesheet><link href=https://charmer.fun/deep-thought.css rel=stylesheet><title> Aurora | HyperLogLog </title><script src="https://www.googletagmanager.com/gtag/js?id=G-LXDSXGWDES" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-LXDSXGWDES");</script><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js></script><body class=has-background-white><nav aria-label="section navigation" class="navbar is-light" role=navigation><div class=container><div class=navbar-brand><a class="navbar-item is-size-5 has-text-weight-bold" href=https://charmer.fun>Aurora</a><a class="navbar-burger burger" aria-expanded=false aria-label=menu data-target=navMenu role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navMenu><div class="navbar-end has-text-centered"><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/> Home </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/posts> Posts </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/categories> Categories </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/tags> Tags </a><a class=navbar-item data-target=#search-modal id=nav-search title=Search> <span class=icon> <i class="fas fa-search"></i> </span> </a><a title="Switch to dark theme" class=navbar-item id=dark-mode> <span class=icon> <i class="fas fa-adjust"></i> </span> </a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-8 is-offset-2"><article class=box><h1 class=title>HyperLogLog</h1><p class=subtitle>用于低开销估算多集合（multiset）的基数（count-distinct）的算法<div class="columns is-multiline is-gapless"><div class="column is-8"><span class="icon-text has-text-grey"> <span class=icon> <i class="fas fa-user"></i> </span> <span>charmer published on</span> <span class=icon> <i class="far fa-calendar-alt"></i> </span> <span><time datetime=2022-02-27T17:15:52+08:00>February 27, 2022</time></span> </span></div><div class="column is-4 has-text-right-desktop"><span class="icon-text has-text-grey"> <span class=icon> <i class="far fa-clock"></i> </span> <span>8 min,</span> <span class=icon> <i class="fas fa-pencil-alt"></i> </span> <span>1545 words</span> </span></div><div class=column><p>Categories: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/categories/probabilisticdatastructure/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>ProbabilisticDataStructure</span> </span> </a></div><div class="column has-text-right-desktop"><p>Tags: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/tags/data-structure/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>data structure</span> </span> </a></div></div><div class="content mt-2"><p>基数统计问题（<em>Count-distinct problem</em>）是指在具有重复元素的数据流中找到不同元素的数目的，该问题有许多场景，比如统计通过某个路由器的ip数量、统计访问某网站的用户数以及数据库总某一字段的基数。<h2 id=b-tree>B-tree</h2><p>首先，基数统计的难点有：<ol><li><p>查找元素</p><li><p>插入元素</p></ol><p>由于海量数据存储于磁盘，我们自然会考虑到B树。这里不细展开，只说优缺点。虽然B树查找、插入效率与内存占用上都很均衡，但是每一条记录实际都被完整存储，对于基数统计而言是没必要的；并且B树之间无法合并，对于网站场景，想统计两个页面访问用户数时，除非特意建立两个页面的B树，否则无法办到。<h2 id=hashset-bitmap>HashSet/Bitmap</h2><p>为了克服B树遇到的问题，我们自然想到将元数据内容转为数字，存储于数组中，也就是使用HashSet。更进一步，可以直接考虑使用Bitmap来统计。既可以快速查找、插入元素，也可以合并。<p>但是Bitmap有着天然的缺陷，它的长度预先设置，取决于数据的范围（也就是值域，domain）。假设我有10GB个数需要统计，那就需要分配10GB的Bitmap，就算这10GB的数全都是一个。<blockquote><p>这里补充一句，可以使用压缩位图来缓解这个问题，比如roaring-bitmap。</blockquote><h2 id=linear-counting-lc-1>Linear Counting(LC)${}^{[1]}$</h2><p>到这里我们可以发现，想要查找快、插入快、可以合并且内存占用低的数据结构恐怕人类还没掌握。不妨思考人类的超级手段：估计，我们可以试着利用概率去估计出基数。<p>需要：<ul><li><p>q个输入元素$\overrightarrow{a}={ a_0, a_1, a_2, .., a_{q-1}}$</p><li><p>长度为m的Bitmap</p><li><p>一个结果服从均匀分布的hash函数，值域[0, m-1]</p></ul><p>输出<ul><li>元素集合$\overrightarrow{a}$的基数估计$n$</ul><p>特点<ul><li>空间复杂度相对于Bitmap仅仅有常数级别降低，因此仍然不适用于大数据集场景</ul><h3 id=ji-ben-si-xiang>基本思想</h3><p><img alt=LC图示 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/linear_counting.drawio.svg><p>输入元素集合$\overrightarrow{a}$服从均匀分布，其hash结果$hash(\overrightarrow{a})={b_0,b_1,…,b_{q-1}},0\le{}b_i \le{m-1}也$服从均匀分布。将Bitmap中下标$b_i, 0\le{}i\le{}q$位置1，统计Bitmap中仍为0的个数记为$u$，则$n$的最大释然估计$\hat{n}=-mlog(\dfrac{u}{m})$<blockquote><p>数学证明非常庞大复杂，请读者自行阅读论文，我就不班门弄斧了。</blockquote><h2 id=loglog-counting-llc-2>LogLog Counting(LLC)${}^{[2]}$</h2><p>LC算法空间利用率仍然不高，是否可以进一步优化呢？这就是LLC。<p>让我借用论文的例子，对于伯努利过程A：不停抛掷一枚均匀硬币，出现反面则继续抛掷，出现正面则停止抛掷，抛掷出的反面次数为$k$。可以得知$P_A(x=k)=(\frac{1}{2})^{k}\quad{}k=0,1,2,3,4,5,…$<p>思考两个问题：<ol><li><p>进行$n$次过程A，每一次过程的总抛掷次数都不大于某个常数$k_{max}$的概率为？</p> <p>易得$P_1(x\le{}k_{max})=[1-(\frac{1}{2})^{k_{max}}]^n$</p><li><p>进行n次过程A，至少有一次过程的总抛掷次数等于某个常数$k_{max}$的概率为？</p> <p>易得$P_2(x=k_{max})=1 – P_1(x\le{}k_{max}–1)=1-[1-(\frac{1}{2})^{k_{max}-1}]^n$</p></ol><p>由于<ul><li><p>$n >> 2^{k_{max}}, \quad P_1(x \leq k_{max}) \approx 0$</p><li><p>$n << 2^{k_{max}}, \quad P_2(x = k_{max}) \approx 0$</p></ul><p>因此我们可以认为n和$2^{k_{max}}$相近～<p>需要：<ul><li><p>输入元素集合</p><li><p>分桶位数$l$，得到$m=2^l$个桶</p><li><p>一个结果服从均匀分布的hash函数，结果长度为$L$</p></ul><p>输出<ul><li>元素集合的基数估计$n$</ul><p>特点<ul><li>标准差为$\dfrac{1.3}{\sqrt{2^l}}$<li>空间复杂度$O(log(log(n)))$</ul><h3 id=ji-ben-si-xiang-1>基本思想</h3><p>说了这么多，那么到底有什么用呢？接下来我就从易于理解的方式介绍LLC。<p>在hash的过程，若hash结果固定，而且hash函数随机性很好，hash函数不尝试碰撞，那么可以认为每一个元素进行哈希后的值转化为2进制串的结果是一个伯努利过程。因此$k_{max}$为从二进制字串高位开始第一个1的位置，$2^{k_{max}}$为基数n的一个估计。<p>但是单次实验偶然性造成的误差会很大，要如何避免呢？增加几个hash函数，每次插入时并行计算？LLC采用了分桶计算的方式。将hash串前$l$位作为bucket编号，后面的位继续做LLC估算（由于伯努利过程每次实验相互独立，因此去掉前面$l$位并不影响后续的伯努利过程）。假设分了m个桶，第$i, 0\le{}i\le{}m-1$个bucket的第一个1的位置最大值为$M_i$，则LLC的结果为$\hat{n}=2^{\frac{\sum_{i=0}^{m-1}(M_i)}{m}}$。<p><img alt=分桶重复实验 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/loglog_count.drawio.svg><blockquote><p>本节介绍的LLC并不是无偏估计，更逻辑严密的推导过程详见论文。</blockquote><h2 id=hyperloglog-hll-3>HyperLogLog(HLL)${}^{[3]}$</h2><p>HLL是LLC的改进，用<strong>调和平均数</strong>取代了<strong>算术平均数</strong>。<p>算术平均数对于离群值十分敏感，在基数总数比较小时，可能会存在比较多的空桶，会干扰平均数的稳定性。<p>HLL的结果不加证明给出$\hat{n}=\dfrac{\alpha_m m^2}{\sum 2^{-M}}$，其中$\alpha_m$为后续无偏渐进化的参数$\alpha_m=(m\int _0^\infty (log_2(\frac{2+u}{1+u}))^m du)^{-1}$<p>特点<ul><li>标准差为$\dfrac{1.04}{\sqrt{m}}$<li>空间复杂度O(log(log(n)))</ul><p>HLL的代码实践可以参考<a rel="noopener nofollow noreferrer" href=https://github.com/addthis/stream-lib/blob/master/src/main/java/com/clearspring/analytics/stream/cardinality/HyperLogLog.java target=_blank>stream-lib/HyperLogLog.java at master · addthis/stream-lib (github.com)</a><h2 id=can-kao>参考</h2><ul><li><p>[1] Whang, Kyu-Young et al. "A linear-time probabilistic counting algorithm for database applications." <em>ACM Trans. Database Syst.</em> 15 (1990): 208-229.</p><li><p>[2] Marianne Durand, Philippe Flajolet. "Loglog Counting of Large Cardinalities (Extended Abstract)"</p><li><p>[3] Philippe Flajolet and Éric Fusy and Olivier Gandouet and Frédéric Meunier. "HyperLogLog: the analysis of a near-optimal cardinality estimation algorithm"</p></ul></div></article></div><div class="column is-2 is-hidden-mobile"><aside style="position: sticky; top: 48px" class=menu><p class="heading has-text-weight-bold">Contents<ul class=menu-list><li><a class="toc is-size-7 is-active" href=https://charmer.fun/posts/hyper-log-log/#b-tree id=link-b-tree> B-tree </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#hashset-bitmap id=link-hashset-bitmap> HashSet/Bitmap </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#linear-counting-lc-1 id=link-linear-counting-lc-1> Linear Counting(LC)${}^{[1]}$ </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#ji-ben-si-xiang id=link-ji-ben-si-xiang> 基本思想 </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#loglog-counting-llc-2 id=link-loglog-counting-llc-2> LogLog Counting(LLC)${}^{[2]}$ </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#ji-ben-si-xiang-1 id=link-ji-ben-si-xiang-1> 基本思想 </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#hyperloglog-hll-3 id=link-hyperloglog-hll-3> HyperLogLog(HLL)${}^{[3]}$ </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/hyper-log-log/#can-kao id=link-can-kao> 参考 </a></ul></aside></div></div></div></section><section class=modal id=search-modal><div class=modal-background></div><div class=modal-card><header class=modal-card-head><p class=modal-card-title>Search</header><section class=modal-card-body><div class="field mb-2"><div class=control><input placeholder="Search this website." class=input id=search type=search></div></div><div class=search-results><div class=search-results__items></div></div></section></div><button class="modal-close is-large" aria-label=close></button></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-8"><nav class=level><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/a-quick-introduction-to-c-plus-plus/> <span class="icon mr-2"> <i class="fas fa-arrow-circle-left"></i> </span> 通过例子快速入门C++ </a></div><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/bloom-filter-2/> 可扩展布隆过滤器<span class="icon ml-2"> <i class="fas fa-arrow-circle-right"></i> </span> </a></div></nav></div></div></div></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-6"><div id=disqus_thread></div></div></div></div></section><footer class="footer py-4"><div class="content has-text-centered"><p>Built with <span class=icon-text> <span class=icon> <i class="fas fa-code"></i> </span> <span>code</span> </span> and <span class=icon-text> <span class=icon> <i class="fas fa-heart"></i> </span> <span>love</span> </span><p>Powered by <span class=icon-text> <span class=icon> <i class="fas fa-power-off"></i> </span> <span>zola</span> </span></div></footer><script crossorigin=anonymous integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js></script><script crossorigin=anonymous integrity=sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js></script><script crossorigin=anonymous integrity=sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js></script><script crossorigin=anonymous integrity=sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv src=https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js></script><script crossorigin=anonymous integrity=sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs src=https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js></script><script src=https://charmer.fun/elasticlunr.min.js></script><script src=https://charmer.fun/search_index.zh.js></script><script src=https://charmer.fun/js/site.js></script><script>const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);</script><script>var disqus_config = function () {
    this.page.url = "https://charmer.fun";
    this.page.identifier = "/posts/hyper-log-log/";
  };

  (function () {
    var d = document, s = d.createElement('script');
    s.src = 'https://oliverdding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();</script>