<!doctype html><html lang=zh><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ffffff name=theme-color><meta content=#da532c name=msapplication-TileColor><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css integrity=sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css integrity=sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6 rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity=sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm rel=stylesheet><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css integrity=sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q rel=stylesheet><link href=https://charmer.fun/deep-thought.css rel=stylesheet><title> Aurora | 基础布隆过滤器 </title><script src="https://www.googletagmanager.com/gtag/js?id=G-LXDSXGWDES" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-LXDSXGWDES");</script><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js></script><body class=has-background-white><nav aria-label="section navigation" class="navbar is-light" role=navigation><div class=container><div class=navbar-brand><a class="navbar-item is-size-5 has-text-weight-bold" href=https://charmer.fun>Aurora</a><a class="navbar-burger burger" aria-expanded=false aria-label=menu data-target=navMenu role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navMenu><div class="navbar-end has-text-centered"><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/> Home </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/posts> Posts </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/categories> Categories </a><a class="navbar-item has-text-weight-semibold" href=https://charmer.fun/tags> Tags </a><a class=navbar-item data-target=#search-modal id=nav-search title=Search> <span class=icon> <i class="fas fa-search"></i> </span> </a><a title="Switch to dark theme" class=navbar-item id=dark-mode> <span class=icon> <i class="fas fa-adjust"></i> </span> </a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-8 is-offset-2"><article class=box><h1 class=title>基础布隆过滤器</h1><p class=subtitle>最普通的布隆过滤器，涉及结构解释和数学推导<div class="columns is-multiline is-gapless"><div class="column is-8"><span class="icon-text has-text-grey"> <span class=icon> <i class="fas fa-user"></i> </span> <span>charmer published on</span> <span class=icon> <i class="far fa-calendar-alt"></i> </span> <span><time datetime=2022-02-09T17:13:10+08:00>February 09, 2022</time></span> </span></div><div class="column is-4 has-text-right-desktop"><span class="icon-text has-text-grey"> <span class=icon> <i class="far fa-clock"></i> </span> <span>8 min,</span> <span class=icon> <i class="fas fa-pencil-alt"></i> </span> <span>1583 words</span> </span></div><div class=column><p>Categories: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/categories/probabilisticdatastructure/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>ProbabilisticDataStructure</span> </span> </a></div><div class="column has-text-right-desktop"><p>Tags: <a class="has-text-info-dark has-text-weight-semibold" href=https://charmer.fun/tags/data-structure/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>data structure</span> </span> </a></div></div><div class="content mt-2"><h2 id=jie-shao>介绍</h2><p>布隆过滤器（Bloom Filter）用于判断某个元素是否在集合中的一个简单、高效、内存占用低的数据结构，它类似于哈希表，相比于后者，它存在false positive值，但显著地降低了内存占用。这种<a href=/categories/probabilisticdatastructure/>概率性数据结构</a>值得体会，以退为进，<em>只要false positive控制在可以允许的范围</em>，资源消耗被大幅降低[4]。<p>使用布隆过滤器查找key时，返回值可能情况有两种：<ol><li>key<strong>不</strong>存在<li>key<strong>可能</strong>存在（存在、纳伪）</ol><h3 id=li-shi>历史</h3><p>布隆过滤器于1970年代被Burton Bloom创造，在查询集合成员存在与否时一般考虑时间成本或空间成本，论文提出第三个优化方向：Allowable Fraction of Errors，也就是说允许一定的误判，来大幅降低空间占用<sup class=footnote-reference><a href=#1>1</a></sup>。之后一段时间布隆过滤器被广泛运用在数据库领域。<p>之后又有人提出利用布隆过滤器+共享缓存的方式大幅降低缓存服务器的带宽<sup class=footnote-reference><a href=#2>2</a></sup>，自此布隆过滤器在互联网中展现实力<sup class=footnote-reference><a href=#3>3</a></sup>。<h3 id=yuan-li>原理</h3><p>布隆过滤器由以下三部分构成：<ol><li>n个key<li>m位的位图：<code>bitmap</code><li>k个相互独立的hash函数：<code>h1, h2, ..., hk</code></ol><blockquote><p>可以用$h_{i}(x)=MD5(x+i)$或者$h_{i}(x)=MD5(x|i)$实现k个无关hash函数</blockquote><p>需要插入key时，对<code>key = a</code>时，经过k个hash函数后得到k个数<code>h1(a), h2(a), ..., hk(a)</code>，此时将<code>bitmap</code>中对应的位置1。<p><img alt=往布隆过滤器插入新key src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/inserting-key-into-bloom-filter.drawio.svg><p>需要查询key时，同样经过k个hash函数得到k个体数，查询<code>bitmap</code>中对应位，若全为1，则key<strong>可能</strong>存在；若任意位为0，则<strong>一定不</strong>存在。（这里可以利用短路减少消耗，若出现0则直接返回不存在）<p>当key越来越多，<code>bitmap</code>中为1的位越多，对于某个不存在的key，k个hash函数得到的坐标对应<code>bitmap</code>中的值都为1的概率越大，此时就发生false positive。<h3 id=li-zi>例子</h3><p>为了直观描述布隆过滤器如何加速查询的，我们用数据库场景来描述。<p>我们对表中某个字段建立bloom filter，假设有10位的bitmap如下所示：<table><thead><tr><th>0<th>1<th>2<th>3<th>4<th>5<th>6<th>7<th>8<th>9<tbody><tr><td>0<td>0<td>0<td>0<td>0<td>0<td>0<td>0<td>0<td>0</table><p>我们使用Fnv和Murmur这两个hash函数。<p>首先插入字符串<code>hello</code>，计算<code>Fnv=6</code>，<code>Murmur=0</code>，于是bitmap如下所示：<table><thead><tr><th>0<th>1<th>2<th>3<th>4<th>5<th>6<th>7<th>8<th>9<tbody><tr><td>1<td>0<td>0<td>0<td>0<td>0<td>1<td>0<td>0<td>0</table><p>接着插入字符串<code>world</code>，计算<code>Fnv=7</code>，<code>Murmur=1</code>，于是bitmap如下所示：<table><thead><tr><th>0<th>1<th>2<th>3<th>4<th>5<th>6<th>7<th>8<th>9<tbody><tr><td>1<td>1<td>0<td>0<td>0<td>0<td>1<td>1<td>0<td>0</table><p>此时我们查询<code>charmer</code>是否存在，计算<code>Fnv=12</code>，<code>Murmur=10</code>，bitmap中存在0，因此<strong>不存在</strong>。<p>再查询<code>hello</code>是否存在，计算<code>Fnv=6</code>，<code>Murmur=0</code>，bitmap中都为1，因此<strong>可能存在</strong>，需要访问磁盘，得知真的存在。<p>再查询<code>zaslf</code>是否存在，计算<code>Fnv=7</code>，<code>Murmur=1</code>，bitmap都为1，因此<strong>可能存在</strong>，需要访问磁盘，得知它不存在。这次磁盘访问就是false positive带来的坏影响，多余的磁盘访问。<p><img alt=布隆过滤器加速查询 src=https://raw.githubusercontent.com/oliverdding/imaw.io/main/bloom-filter-speed-up-answers.drawio.svg><h2 id=shu-xue-tui-dao>数学推导</h2><p><strong>k取何值时，false positive发生概率最小，此时概率为？</strong><p>由于hash函数“选择”<code>bitmap</code>的位置是随机的，因此对于长度为m的<code>bitmap</code>而言，插入一个值时某个位被置1、0的概率分别是$P(1) = \frac{1}{m}$、$P(0) = 1 - \frac{1}{m}$<p>当k个hash函数置位后，对于任意一个位，仍然是0的概率是$$P'(0)=P(0)^{k}=(1 - \frac{1}{m})^{k}$$<p>对于n个key插入后，对于任意一个位，仍然是0的概率是$$P''(0)=P'(0)^{n}=(1 - \frac{1}{m})^{kn}$$<p>由于有自然对数e的计算公式$$\lim_{x \to \infty}{(1-\frac{1}{x})^{-x}}=e$$<p>我们可以<strong>近似</strong>计算$P''(0)$得到$$P''(0)=((1-\frac{1}{m})^{-m})^{-\frac{kn}{m}}\approx{}e^{-\frac{kn}{m}}$$<p>因此，对于任意一个位，其被置1的概率是$$P''(1)=1-P''(0)\approx{}1-e^{-\frac{kn}{m}}$$<p>当alse positive发生时，是指它的k个hash函数得到的位置都为1。由于k个hash函数相互独立，我们可以计算出alse positive的概率为$$\varepsilon=(1-(1-\frac{1}{m})^{kn})^{k}\approx{}(1-e^{-\frac{kn}{m}})^{k}$$<p>由于m、n是用户给定的值，唯一变量就是k，我们需要指定k的值去最小化alse positive概率。<p>令$p=e^{-\frac{kn}{m}}$以及自然对数公式，我们有$$\varepsilon=(1-p)^{k}=e^{kln(1-p)}$$<p>此时变更为最小的$g=kln(1-p)$<p>无中生有下得到$$g=kln{}(1-p)=-\frac{m}{n}ln(e^{-\frac{kn}{m}})ln(1-p)=-\frac{m}{n}ln(p)ln(1-p)$$<p>根据对称性原理得知当$p=\frac{1}{2}$时g取得最小，此时有$$k=\frac{m}{n}ln(2)$$<p>插入回$$\varepsilon=(1-p)^{k}$$得到alse positive的最小值为$$\varepsilon_{min}=(\frac{1}{2})^{k}\approx{}(0.6185)^{\frac{m}{n}}$$<h2 id=ying-yong>应用</h2><p>那么如何在项目中使用bloom filter呢？<h3 id=yi-zhi-n-he-varepsilon>已知$n$和$\varepsilon$</h3><p>$n$由系统输入决定，$\varepsilon$则是开发者平衡内存使用和性能的选择，因此可以通过传入这两个变量自动计算剩下的值。<ol><li>根据公式$m=\lceil{}-\frac{nln(\varepsilon)}{(ln(2))^2}\rceil$计算m的值<li>根据公式$k=\lceil{}-log_2(\varepsilon)\rceil$计算k的值</ol><h2 id=que-xian>缺陷</h2><p>基础bloom filter有着自己的局限性，因此出现了许多变种，它们为了特殊场景作出不同的定制，增加一定开销换取更多功能：<ul><li><a href=/posts/bloom-filter-2/>可扩展布隆过滤器</a>：基础bloom filter必须预先知道元素数量以分配空间<li>计数布隆过滤器：基础bloom filter无法删除元素，只能重建<li><a href=/posts/count-min-sketch/>Count-Min Sketch</a>：利用计数布隆过滤器相同变体实现各基数数量统计能力</ul><h2 id=can-kao>参考</h2><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>Space/Time Trade-offs in Hash Coding with Allowable Errors <sup class=footnote-reference><a href=#2>2</a></sup>: Summary Cache: A Scalable Wide-Area Web Cache Sharing Protocol <sup class=footnote-reference><a href=#3>3</a></sup>: Network Applications of Bloom Filters: A Survey <sup class=footnote-reference><a href=#4>4</a></sup>: Bloom Filters by Example. https://llimllib.github.io/bloomfilter-tutorial/</div></div></article></div><div class="column is-2 is-hidden-mobile"><aside style="position: sticky; top: 48px" class=menu><p class="heading has-text-weight-bold">Contents<ul class=menu-list><li><a class="toc is-size-7 is-active" href=https://charmer.fun/posts/bloom-filter-1/#jie-shao id=link-jie-shao> 介绍 </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#li-shi id=link-li-shi> 历史 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#yuan-li id=link-yuan-li> 原理 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#li-zi id=link-li-zi> 例子 </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#shu-xue-tui-dao id=link-shu-xue-tui-dao> 数学推导 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#ying-yong id=link-ying-yong> 应用 </a> <ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#yi-zhi-n-he-varepsilon id=link-yi-zhi-n-he-varepsilon> 已知$n$和$\varepsilon$ </a></ul><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#que-xian id=link-que-xian> 缺陷 </a><li><a class="toc is-size-7" href=https://charmer.fun/posts/bloom-filter-1/#can-kao id=link-can-kao> 参考 </a></ul></aside></div></div></div></section><section class=modal id=search-modal><div class=modal-background></div><div class=modal-card><header class=modal-card-head><p class=modal-card-title>Search</header><section class=modal-card-body><div class="field mb-2"><div class=control><input placeholder="Search this website." class=input id=search type=search></div></div><div class=search-results><div class=search-results__items></div></div></section></div><button class="modal-close is-large" aria-label=close></button></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-8"><nav class=level><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/best-practice-for-writing-blog-with-ssg/> <span class="icon mr-2"> <i class="fas fa-arrow-circle-left"></i> </span> 使用静态网站写博客的最佳实践 </a></div><div class="level-item has-text-centered"><a class="button is-black is-outlined" href=https://charmer.fun/posts/apache-arrow-the-next-windfall-after-the-data-lake-in-big-data/> Apache Arrow: 大数据在数据湖后的下一个风向标<span class="icon ml-2"> <i class="fas fa-arrow-circle-right"></i> </span> </a></div></nav></div></div></div></section><section class=section><div class=container><div class="columns is-centered"><div class="column is-6"><div id=disqus_thread></div></div></div></div></section><footer class="footer py-4"><div class="content has-text-centered"><p>Built with <span class=icon-text> <span class=icon> <i class="fas fa-code"></i> </span> <span>code</span> </span> and <span class=icon-text> <span class=icon> <i class="fas fa-heart"></i> </span> <span>love</span> </span><p>Powered by <span class=icon-text> <span class=icon> <i class="fas fa-power-off"></i> </span> <span>zola</span> </span></div></footer><script crossorigin=anonymous integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js></script><script crossorigin=anonymous integrity=sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js></script><script crossorigin=anonymous integrity=sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY src=https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js></script><script crossorigin=anonymous integrity=sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv src=https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js></script><script crossorigin=anonymous integrity=sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs src=https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js></script><script src=https://charmer.fun/elasticlunr.min.js></script><script src=https://charmer.fun/search_index.zh.js></script><script src=https://charmer.fun/js/site.js></script><script>const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);</script><script>var disqus_config = function () {
    this.page.url = "https://charmer.fun";
    this.page.identifier = "/posts/bloom-filter-1/";
  };

  (function () {
    var d = document, s = d.createElement('script');
    s.src = 'https://oliverdding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();</script>